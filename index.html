<!DOCTYPE html>

<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cek Pemilih dari Kartu Keluarga</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }
    
    .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 700;
    }
    
    .header p {
        font-size: 1.1em;
        opacity: 0.9;
    }
    
    .content {
        padding: 40px;
    }
    
    .upload-section {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        margin-bottom: 30px;
        transition: all 0.3s ease;
    }
    
    .upload-section:hover {
        border-color: #007bff;
        background: #f0f8ff;
    }
    
    .upload-section.dragover {
        border-color: #28a745;
        background: #f0fff4;
        transform: scale(1.02);
    }
    
    .file-input-wrapper {
        position: relative;
        display: inline-block;
        margin-bottom: 20px;
    }
    
    .file-input {
        position: absolute;
        left: -9999px;
        opacity: 0;
    }
    
    .file-input-label {
        display: inline-block;
        padding: 12px 30px;
        background: #007bff;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
    }
    
    .file-input-label:hover {
        background: #0056b3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    
    .file-name {
        margin-top: 15px;
        font-size: 14px;
        color: #28a745;
        font-weight: 500;
    }
    
    .year-section {
        margin-bottom: 30px;
    }
    
    .year-section label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: #2c3e50;
        font-size: 16px;
    }
    
    .year-input {
        width: 200px;
        padding: 12px 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
    }
    
    .year-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }
    
    .check-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 18px;
        font-weight: 600;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(40,167,69,0.3);
    }
    
    .check-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40,167,69,0.4);
    }
    
    .check-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .result {
        margin-top: 30px;
        min-height: 50px;
    }
    
    .loading {
        text-align: center;
        padding: 20px;
        color: #007bff;
    }
    
    .loading::after {
        content: '...';
        animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
        0%, 33% { content: '.'; }
        34%, 66% { content: '..'; }
        67%, 100% { content: '...'; }
    }
    
    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #dc3545;
    }
    
    .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #28a745;
    }
    
    .info {
        background: #cce7ff;
        color: #004085;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        margin-bottom: 20px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .container {
            margin: 10px;
            border-radius: 10px;
        }
        
        .content {
            padding: 20px;
        }
        
        .header {
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2em;
        }
        
        .year-input {
            width: 100%;
            max-width: 300px;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó≥Ô∏è Cek Pemilih</h1>
            <p>Analisis data pemilih dari Kartu Keluarga (KK)</p>
        </div>

```
    <div class="content">
        <div class="info">
            <strong>‚ÑπÔ∏è Cara Penggunaan:</strong><br>
            1. Upload foto/scan Kartu Keluarga (KK) yang jelas<br>
            2. Masukkan tahun pemilihan yang ingin dianalisis<br>
            3. Klik tombol "Cek Pemilih" untuk memulai analisis
        </div>
        
        <div class="upload-section" id="uploadSection">
            <div class="file-input-wrapper">
                <input type="file" id="kkFile" class="file-input" accept="image/*">
                <label for="kkFile" class="file-input-label">
                    üìÅ Pilih File KK
                </label>
            </div>
            <div id="fileName" class="file-name"></div>
            <p style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                Format yang didukung: JPG, PNG, PDF<br>
                Ukuran maksimal: 10MB
            </p>
        </div>
        
        <div class="year-section">
            <label for="targetYear">üìÖ Tahun Pemilihan:</label>
            <input type="number" id="targetYear" class="year-input" 
                   min="2000" max="2100" value="2024" 
                   placeholder="Contoh: 2024">
        </div>
        
        <div style="text-align: center;">
            <button id="checkVoters" class="check-button">
                üîç Cek Pemilih
            </button>
        </div>
        
        <div id="result" class="result"></div>
    </div>
</div>

<script>
    // Event listener untuk file input
    document.getElementById('kkFile').addEventListener('change', function(e) {
        const fileName = document.getElementById('fileName');
        const file = e.target.files[0];
        
        if (file) {
            fileName.textContent = `‚úÖ File dipilih: ${file.name}`;
            fileName.style.display = 'block';
        } else {
            fileName.textContent = '';
            fileName.style.display = 'none';
        }
    });

    // Drag and drop functionality
    const uploadSection = document.getElementById('uploadSection');
    const fileInput = document.getElementById('kkFile');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadSection.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadSection.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadSection.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        uploadSection.classList.add('dragover');
    }

    function unhighlight() {
        uploadSection.classList.remove('dragover');
    }

    uploadSection.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            fileInput.files = files;
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
        }
    }

    // Main event listener untuk tombol cek
    document.getElementById('checkVoters').addEventListener('click', async function() {
        console.log('Tombol diklik!'); // Debug log
        
        const fileInput = document.getElementById('kkFile');
        const resultDiv = document.getElementById('result');
        const targetYear = parseInt(document.getElementById('targetYear').value);
        const file = fileInput.files[0];
        const button = this;

        // Validasi input
        if (!file) {
            resultDiv.innerHTML = '<div class="error">‚ö†Ô∏è Mohon pilih file Kartu Keluarga terlebih dahulu.</div>';
            return;
        }
        
        if (!targetYear || targetYear < 2000 || targetYear > 2100) {
            resultDiv.innerHTML = '<div class="error">‚ö†Ô∏è Mohon masukkan tahun yang valid (2000-2100).</div>';
            return;
        }

        // Disable button dan show loading
        button.disabled = true;
        button.textContent = '‚è≥ Memproses...';
        resultDiv.innerHTML = `<div class="loading">‚è≥ Menganalisis data untuk tahun ${targetYear}, mohon tunggu</div>`;

        // Baca file
        const reader = new FileReader();
        reader.onloadend = async () => {
            const base64Image = reader.result;
            
            try {
                console.log('Mengirim request ke server...'); // Debug log
                
                const response = await fetch('/.netlify/functions/generate-voter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ base64Image, targetYear }),
                });

                console.log('Response status:', response.status); // Debug log
                
                const data = await response.json();
                console.log('Data received:', data); // Debug log
                
                if (data.error) {
                    resultDiv.innerHTML = `<div class="error">‚ùå ${data.error}</div>`;
                    return;
                }
                
                // Process and display results
                processAndDisplayResults(data, targetYear);

            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = '<div class="error">‚ùå Terjadi kesalahan saat menghubungi server. Silakan coba lagi.</div>';
            } finally {
                // Re-enable button
                button.disabled = false;
                button.textContent = 'üîç Cek Pemilih';
            }
        };

        reader.onerror = () => {
            resultDiv.innerHTML = '<div class="error">‚ùå Gagal membaca file. Silakan coba file lain.</div>';
            button.disabled = false;
            button.textContent = 'üîç Cek Pemilih';
        };

        reader.readAsDataURL(file);
    });

    // Function untuk memproses dan menampilkan hasil
    function processAndDisplayResults(data, year) {
        const resultDiv = document.getElementById('result');
        
        const pemilih_sah = [];
        const tidak_memenuhi_syarat = [];

        // Validasi data
        if (!data || !data.anggota_keluarga || !Array.isArray(data.anggota_keluarga)) {
            resultDiv.innerHTML = '<div class="error">‚ùå Format data dari server tidak sesuai. Tidak ditemukan daftar anggota keluarga.</div>';
            return;
        }

        if (data.anggota_keluarga.length === 0) {
            resultDiv.innerHTML = '<div class="error">‚ö†Ô∏è Tidak ditemukan data anggota keluarga dalam gambar KK. Pastikan gambar jelas dan terbaca.</div>';
            return;
        }

        // Process setiap anggota keluarga
        data.anggota_keluarga.forEach(orang => {
            if (!orang.nama || orang.usia_pada_tahun_target === undefined || !orang.status_perkawinan) {
                tidak_memenuhi_syarat.push({
                    nama: orang.nama || 'Nama tidak terbaca',
                    alasan: 'Data tidak lengkap'
                });
                return;
            }

            const usia = parseInt(orang.usia_pada_tahun_target);
            const status = orang.status_perkawinan.toString().toUpperCase().trim();
            
            if (isNaN(usia) || usia < 0 || usia > 150) {
                tidak_memenuhi_syarat.push({
                    nama: orang.nama,
                    alasan: 'Usia tidak valid'
                });
                return;
            }

            // Logika penentu pemilih
            if (usia >= 17 || status === "KAWIN" || status === "MARRIED") {
                let alasan = '';
                if (usia >= 17 && (status === "KAWIN" || status === "MARRIED")) {
                    alasan = `Berusia ${usia} tahun dan sudah menikah`;
                } else if (usia >= 17) {
                    alasan = `Berusia ${usia} tahun`;
                } else if (status === "KAWIN" || status === "MARRIED") {
                    alasan = `Sudah menikah (usia ${usia} tahun)`;
                }
                
                pemilih_sah.push({
                    nama: orang.nama,
                    alasan: alasan
                });
            } else {
                tidak_memenuhi_syarat.push({
                    nama: orang.nama,
                    alasan: `Belum cukup umur (${usia} tahun) dan belum menikah`
                });
            }
        });

        // Display results
        displayResults(pemilih_sah, tidak_memenuhi_syarat, year);
    }

    function displayResults(pemilih_sah, tidak_memenuhi_syarat, year) {
        const resultDiv = document.getElementById('result');
        
        const totalAnggota = pemilih_sah.length + tidak_memenuhi_syarat.length;
        
        let html = `
            <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin: 20px 0; border: 1px solid #dee2e6;">
                <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üìä Hasil Analisis Pemilih Tahun ${year}</h3>
                
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">üìà Ringkasan</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 6px;">
                            <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${totalAnggota}</div>
                            <div style="color: #424242; font-size: 14px;">Total Anggota</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 6px;">
                            <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">${pemilih_sah.length}</div>
                            <div style="color: #424242; font-size: 14px;">Memenuhi Syarat</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #ffebee; border-radius: 6px;">
                            <div style="font-size: 24px; font-weight: bold; color: #c62828;">${tidak_memenuhi_syarat.length}</div>
                            <div style="color: #424242; font-size: 14px;">Tidak Memenuhi</div>
                        </div>
                    </div>
                </div>
        `;

        if (pemilih_sah.length > 0) {
            html += `
                <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #4caf50;">
                    <h4 style="color: #2e7d32; margin: 0 0 15px 0;">‚úÖ Pemilih yang Memenuhi Syarat (${pemilih_sah.length} orang)</h4>
                    <ul style="margin: 0; padding-left: 20px; list-style-type: none;">
            `;
            
            pemilih_sah.forEach(p => {
                html += `
                    <li style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <strong style="color: #2c3e50;">${p.nama}</strong><br>
                        <small style="color: #4caf50; font-weight: 500;">‚úì ${p.alasan}</small>
                    </li>
                `;
            });
            
            html += '</ul></div>';
        }

        if (tidak_memenuhi_syarat.length > 0) {
            html += `
                <div style="background: #ffebee; padding: 20px; border-radius: 8px; border-left: 5px solid #f44336;">
                    <h4 style="color: #c62828; margin: 0 0 15px 0;">üö´ Tidak Memenuhi Syarat (${tidak_memenuhi_syarat.length} orang)</h4>
                    <ul style="margin: 0; padding-left: 20px; list-style-type: none;">
            `;
            
            tidak_memenuhi_syarat.forEach(tms => {
                html += `
                    <li style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <strong style="color: #2c3e50;">${tms.nama}</strong><br>
                        <small style="color: #f44336; font-weight: 500;">‚úó ${tms.alasan}</small>
                    </li>
                `;
            });
            
            html += '</ul></div>';
        }

        html += '</div>';
        resultDiv.innerHTML = html;
    }

    // Debug: Cek apakah semua element ada
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded');
        console.log('Button element:', document.getElementById('checkVoters'));
        console.log('File input:', document.getElementById('kkFile'));
        console.log('Year input:', document.getElementById('targetYear'));
        console.log('Result div:', document.getElementById('result'));
    });
</script>
```

</body>
</html>
